<link rel="import" href="../polymer/polymer-element.html">

<script>
  var src = 'https://www.youtube.com/iframe_api'

  if (!window.YouTubeIFrame) {
    window.YouTubeIFrame = { 
      apiURL: src,
      apiTag: document.querySelector(`script[src="${src}"]`)
    };
  }

  class YouTubeIFrameAPI extends Polymer.Element {
    static get is() {
      return 'youtube-iframe-api';
    }

    static get properties() {
      return {
        url: {
          type: String,
          value: src,
          readOnly: true
        },
        callbackName: {
          type: String,
          value: 'onYouTubeIframeAPIReady',
          readOnly: true
        }
      }
    }

    connectedCallback() {
      super.connectedCallback();
      this._loadAPI();
    }

    _loadAPI() {
      if (!YouTubeIFrame.apiTag) {
        window[this.callbackName] = this._handleAPILoadCallback.bind(this);
        YouTubeIFrame.apiTag = document.createElement('script');
        YouTubeIFrame.apiTag.src = this.url;
        YouTubeIFrame.apiTag.onerror = this._handleAPILoadError.bind(this);
        var firstScriptTag = document.querySelector('script') || document.body;
        firstScriptTag.parentNode.insertBefore(YouTubeIFrame.apiTag, firstScriptTag);    
      }
    }

    _handleAPILoadError() {
      this.dispatchEvent(new CustomEvent('api-error', { bubbles: true, composed: true }))
    }

    _handleAPILoadCallback() {
      this.dispatchEvent(new CustomEvent('api-load', { bubbles: true, composed: true }));
    }
  }

  customElements.define(YouTubeIFrameAPI.is, YouTubeIFrameAPI);
</script>
