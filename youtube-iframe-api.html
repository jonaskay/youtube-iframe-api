<link rel="import" href="../polymer/polymer-element.html">

<script>
  var src = 'https://www.youtube.com/iframe_api'

  if (!window.YouTubeIFrame) {
    window.YouTubeIFrame = { 
      apiURL: src,
      apiScript: document.querySelector(`script[src="${src}"]`)
    };
  }

  class YouTubeIFrameAPI extends Polymer.Element {
    static get is() {
      return 'youtube-iframe-api';
    }

    static get properties() {
      return {
        url: {
          type: String,
          value: src,
          readOnly: true
        },
        callbackName: {
          type: String,
          value: 'onYouTubeIframeAPIReady',
          readOnly: true
        }
      }
    }

    connectedCallback() {
      super.connectedCallback();
      this._loadAPI();
    }

    _loadAPI() {
      if (!YouTubeIFrame.apiScript) {
        this._addCallbackListener();
        this._addAPIScript();
      }
    }

    _handleAPILoadError() {
      this.dispatchEvent(new CustomEvent('api-error', { bubbles: true, composed: true }))
      this._removeCallbackListener();
      this._removeAPIScript();
    }

    _handleAPILoadCallback() {
      this.dispatchEvent(new CustomEvent('api-load', { bubbles: true, composed: true }));
    }

    _addCallbackListener() {
      window[this.callbackName] = this._handleAPILoadCallback.bind(this);
    }

    _removeCallbackListener() {
      delete window[this.callbackName];
    }

    _addAPIScript() {
      YouTubeIFrame.apiScript = document.createElement('script');
      YouTubeIFrame.apiScript.src = this.url;
      YouTubeIFrame.apiScript.onerror = this._handleAPILoadError.bind(this);
      var firstScriptTag = document.querySelector('script') || document.body;
      firstScriptTag.parentNode.insertBefore(YouTubeIFrame.apiScript, firstScriptTag);    
    }

    _removeAPIScript() {
      YouTubeIFrame.apiScript = null;
      document.querySelector(`script[src="${this.url}"]`).remove();
    }
  }

  customElements.define(YouTubeIFrameAPI.is, YouTubeIFrameAPI);
</script>
